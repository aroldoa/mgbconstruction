!function($){$(function(){function e(){var e={action:"envira_gallery_refresh",post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.refresh_nonce};$(".envira-media-library").after('<span class="spinner envira-gallery-spinner envira-gallery-spinner-refresh"></span>'),$(".envira-gallery-spinner-refresh").css({display:"inline-block","margin-top":"-3px"}),$.post(envira_gallery_metabox.ajax,e,function(e){e&&e.success&&($("#envira-gallery-output").html(e.success),$("#envira-gallery-output").find(".wp-editor-wrap").each(function(e,a){var t=$(a).find(".quicktags-toolbar");if(!(t.length>0)){var n=$(a).attr("id").split("-"),r=n.slice(4,-1).join("-");quicktags({id:"envira-gallery-caption-"+r,buttons:"strong,em,link,ul,ol,li,close"}),QTags._buttonsInit()}}),$("#envira-gallery-output").trigger({type:"enviraRefreshed",html:e.success,id:envira_gallery_metabox.id})),$(".envira-gallery-spinner-refresh").fadeOut(300,function(){$(this).remove()})},"json")}function a(e){var a=$(e).data("envira-conditional").split(","),t=!1;switch($(e).attr("type")){case"checkbox":t=$(e).is(":checked");break;default:t=""==$(e).val()||0==$(e).val()?!1:!0}for(var n=0;n<a.length;n++)t?$("#"+a[n]).fadeIn(300):$("#"+a[n]).fadeOut(300)}0!==$(".envira-helper-needed").length&&$('<div class="envira-meta-helper-overlay" />').prependTo("#envira-gallery"),$(document).on("click",".envira-meta-icon",function(e){e.preventDefault();var a=$(this),t=a.parent(),n=a.next();n.is(":visible")?($(".envira-meta-helper-overlay").remove(),t.removeClass("envira-helper-active")):(0===$(".envira-meta-helper-overlay").length&&$('<div class="envira-meta-helper-overlay" />').prependTo("#envira-gallery"),t.addClass("envira-helper-active"))}),$(document).on("change",'input[name="_envira_gallery[type]"]:radio',function(e){var a=$(this);$(".envira-gallery-type-spinner .envira-gallery-spinner").css({display:"inline-block","margin-top":"-1px"});var t={action:"envira_gallery_change_type",post_id:envira_gallery_metabox.id,type:a.val(),nonce:envira_gallery_metabox.change_nonce};$.post(envira_gallery_metabox.ajax,t,function(e){$("#envira-gallery-main").html("default"==e.type?e.html:e.html),$(document).trigger("enviraGalleryType",e),$(".envira-gallery-type-spinner .envira-gallery-spinner").hide()},"json")}),$(document).on("click",".envira-media-library",function(e){e.preventDefault(),s=!0,$("#envira-gallery-upload-ui").appendTo("body").show()}),$(".envira-gallery-gallery").on("click",".thumbnail, .check, .media-modal-icon",function(e){e.preventDefault(),$(this).parent().parent().hasClass("envira-gallery-in-gallery")||($(this).parent().parent().hasClass("selected")?$(this).parent().parent().removeClass("details selected"):$(this).parent().parent().addClass("details selected"))}),$(".envira-gallery-gallery").bind("scroll",function(){$(this).scrollTop()+$(this).innerHeight()>=this.scrollHeight&&($(".media-toolbar-secondary span.envira-gallery-spinner").css("visibility","visible"),$.post(envira_gallery_metabox.ajax,{action:"envira_gallery_load_library",offset:$(".envira-gallery-gallery").attr("data-envira-gallery-offset"),post_id:envira_gallery_metabox.id,search:$("input#envira-gallery-gallery-search").val(),nonce:envira_gallery_metabox.load_gallery},function(e){var a=Number($(".envira-gallery-gallery").attr("data-envira-gallery-offset"));$(".envira-gallery-gallery").attr("data-envira-gallery-offset",a+20),$(".media-toolbar-secondary span.envira-gallery-spinner").css("visibility","hidden"),$(".envira-gallery-gallery").append(e.html)},"json"))}),$(document).on("keyup keydown","#envira-gallery-gallery-search",function(){o(function(){$(".media-toolbar-secondary span.envira-gallery-spinner").css("visibility","visible"),$.post(envira_gallery_metabox.ajax,{action:"envira_gallery_load_library",offset:0,post_id:envira_gallery_metabox.id,search:$("input#envira-gallery-gallery-search").val(),nonce:envira_gallery_metabox.load_gallery},function(e){$(".envira-gallery-gallery").attr("data-envira-gallery-offset",20),$(".media-toolbar-secondary span.envira-gallery-spinner").css("visibility","hidden"),$(".envira-gallery-gallery").html(e.html)},"json")})}),$(document).on("click",".envira-gallery-media-insert",function(e){e.preventDefault();var a=$(this),t=$(this).text(),n={action:"envira_gallery_insert_images",nonce:envira_gallery_metabox.insert_nonce,post_id:envira_gallery_metabox.id,images:{}},r=!1,i=e;a.text(envira_gallery_metabox.inserting),$(".envira-gallery-media-frame .media-router a").each(function(){if("select-images"==$(this).data("envira-gallery-content"))$(".envira-gallery-media-frame").find(".attachment.selected:not(.envira-gallery-in-gallery)").each(function(e,a){n.images[e]=$(a).attr("data-attachment-id"),r=!0});else{var e=$(this).data("envira-gallery-content"),a=$("#envira-gallery-"+e);n[e]={},$("ul.attachments",$(a)).length>0?$(a).find(".attachment.selected").each(function(a,t){n[e][a]=$(t).attr("data-attachment-id")}):$(a).find(".envira-gallery-form-fields").each(function(a,t){n[e][a]={},$("input,select,textarea",$(this)).each(function(t){n[e][a][$(this).attr("class")]=$(this).val()})})}}),$.post(envira_gallery_metabox.ajax,n,function(e){setTimeout(function(){c(i),a.text(t),r&&$(".envira-gallery-load-library").attr("data-envira-gallery-offset",0).addClass("has-search").trigger("click")},500)},"json")}),$(document).on("click",".envira-gallery-media-frame .media-menu-item",function(e){e.preventDefault();var a=$(this),t=a.parent().find(".active").removeClass("active").data("envira-gallery-content"),n=a.addClass("active").data("envira-gallery-content");$("#envira-gallery-"+t).hide(),$("#envira-gallery-"+n).show()});var t=$("#envira-gallery-output");t.sortable({containment:"#envira-gallery-output",items:"li",cursor:"move",forcePlaceholderSize:!0,placeholder:"dropzone",update:function(e,a){var n={url:envira_gallery_metabox.ajax,type:"post",async:!0,cache:!1,dataType:"json",data:{action:"envira_gallery_sort_images",order:t.sortable("toArray").toString(),post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.sort},success:function(e){},error:function(e,a,t){}};$.ajax(n)}}),$("a.envira-gallery-images-delete").fadeOut(),$("ul#envira-gallery-output").on("click","li.envira-gallery-image > img",function(){var e=$(this).parent();$(e).hasClass("selected")?$(e).removeClass("selected"):$(e).addClass("selected"),$("ul#envira-gallery-output > li.selected").length>0?$("a.envira-gallery-images-delete").fadeIn():$("a.envira-gallery-images-delete").fadeOut()}),$("a.envira-gallery-images-delete").click(function(e){e.preventDefault();var a=confirm(envira_gallery_metabox.remove_multiple);if(!a)return!1;var t=[];$("ul#envira-gallery-output > li.selected").each(function(){t.push($(this).attr("id"))});var n={action:"envira_gallery_remove_images",attachment_ids:t,post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.remove_nonce};$.post(envira_gallery_metabox.ajax,n,function(e){$("ul#envira-gallery-output > li.selected").each(function(){$(this).fadeOut("normal",function(){$(this).remove()})}),$("a.envira-gallery-images-delete").fadeOut(),$(".envira-gallery-load-library").attr("data-envira-gallery-offset",0).addClass("has-search").trigger("click")},"json")}),$("#envira-gallery").on("click",".envira-gallery-remove-image",function(e){e.preventDefault();var a=confirm(envira_gallery_metabox.remove);if(a){var t=$(this).parent().attr("id"),n={action:"envira_gallery_remove_image",attachment_id:t,post_id:envira_gallery_metabox.id,nonce:envira_gallery_metabox.remove_nonce};$.post(envira_gallery_metabox.ajax,n,function(e){$("#"+t).fadeOut("normal",function(){$(this).remove(),$(".envira-gallery-load-library").attr("data-envira-gallery-offset",0).addClass("has-search").trigger("click")})},"json")}});var n=[];$("#envira-gallery").on("click.enviraModify",".envira-gallery-modify-image",function(e){e.preventDefault();var a=$(this).parent().data("envira-gallery-image"),t="envira-gallery-meta-"+a;n=[],$("ul#envira-gallery-output li").each(function(){n.push($(this).data("envira-gallery-image"))}),i(a,t)}),$(document).on("click","button.left, button.right",function(e){e.preventDefault(),l();var a=$(this).attr("data-attachment-id"),t="envira-gallery-meta-"+a;i(a,t)});var r,i=function(e,a){r=$("#"+a).appendTo("body"),$(r).show(),$("button.left",$(r)).removeClass("disabled"),$("button.right",$(r)).removeClass("disabled");for(var t=-1,i=0;i<n.length;i++)if(n[i]==e){t=i;break}0==t?($("button.left",$(r)).addClass("disabled"),$("button.left",$(r)).attr("data-attachment-id",""),n.length>1?($("button.right",$(r)).removeClass("disabled"),$("button.right",$(r)).attr("data-attachment-id",n[t+1])):($("button.right",$(r)).addClass("disabled"),$("button.right",$(r)).attr("data-attachment-id",""))):t==n.length-1?($("button.left",$(r)).removeClass("disabled"),$("button.left",$(r)).attr("data-attachment-id",n[t-1]),$("button.right",$(r)).addClass("disabled"),$("button.right",$(r)).attr("data-attachment-id","")):($("button.left",$(r)).removeClass("disabled"),$("button.left",$(r)).attr("data-attachment-id",n[t-1]),$("button.right",$(r)).removeClass("disabled"),$("button.right",$(r)).attr("data-attachment-id",n[t+1])),$(document).on("click.enviraIframe",".media-modal-close, .media-modal-backdrop",function(e){e.preventDefault(),l()}),$(document).on("keydown.enviraIframe",function(e){27==e.keyCode&&l()})},l=function(){var e=$(r).attr("id"),a=e.split("-"),t=a[a.length-1];$("#"+e).appendTo("#"+t).hide(),s=!1,$(document).off("click.enviraLink")};$(document).on("click",".query-results li.selected",function(e){var a=$("input[type=hidden]",$(this)).val(),t=$(r).attr("id"),n=t.split("-"),i=n[n.length-1];$("input#envira-gallery-link-"+i).val(a)}),$("input.link-search-field").change(function(){""==$(this).val()&&$(".query-results ul").html("")}),$(document).on("click",".envira-gallery-meta-submit",function(e){e.preventDefault();var a=$(this),t=a.text(),n=a.data("envira-gallery-item"),r="envira-gallery-meta-"+n,i={},l=$("span.settings-save-status span.spinner"),o=$("span.settings-save-status span.saved");a.text(envira_gallery_metabox.saving),a.attr("disabled","disabled"),$(l).show(),i.caption=$("#envira-gallery-meta-table-"+n).find('textarea[name="_envira_gallery[meta_caption]"]').val(),$("#envira-gallery-meta-table-"+n).find(":input").not(".ed_button").each(function(e,a){$(this).data("envira-meta")&&(i[$(this).data("envira-meta")]=$(this).val(),"checkbox"==$(this).attr("type")&&($(this).attr("checked")?i[$(this).data("envira-meta")]=$(this).val():i[$(this).data("envira-meta")]=0))});var s={action:"envira_gallery_save_meta",nonce:envira_gallery_metabox.save_nonce,attach_id:n,post_id:envira_gallery_metabox.id,meta:i};$.post(envira_gallery_metabox.ajax,s,function(e){a.text(t),a.attr("disabled",!1),$(l).fadeOut("slow",function(){$(o).fadeIn("fast",function(){setTimeout(function(){$(o).fadeOut("slow")},500)})})},"json")}),$("#envira-gallery-import-submit").on("click",function(e){$(this).next().css("display","inline-block"),0===$("#envira-config-import-gallery").val().length&&(e.preventDefault(),$(this).next().hide(),alert(envira_gallery_metabox["import"]))});var o=function(){var e=0;return function(a,t){clearTimeout(e),e=setTimeout(a,t)}}(),s=!1,c=function(a){a.preventDefault(),$("#envira-gallery-upload-ui").appendTo("#envira-gallery-upload-ui-wrapper").hide(),e(),s=!1};$(document).on("click","#envira-gallery-upload-ui .media-modal-close, #envira-gallery-upload-ui .media-modal-backdrop",c),$(document).on("keydown",function(e){27==e.keyCode&&s&&c(e)}),$("input[data-envira-conditional], select[data-envira-conditional]").each(function(){a(this)}),$("input[data-envira-conditional], select[data-envira-conditional]").change(function(){a(this)})})}(jQuery);